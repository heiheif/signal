# 水下仿真运行流程与算法应用详解

## 1. 引言

水下声学仿真是研究和评估水下探测、通信和对抗系统性能的重要手段。通过模拟复杂的水下声学环境、目标特性以及传感器行为，仿真能够有效地支撑系统设计、战术制定和训练演练。本文档旨在详细阐述一个典型的水下仿真运行流程，并结合提供的 `signal_lib.h` 接口定义和 `算法知识目录.md` 中的算法知识，分析各环节中可能涉及的关键技术和算法。

本文档将重点关注红方（我方，包含坐底侦察UUV、机动侦察UUV、预投/实投潜标等侦察单元）探测和分析蓝方（敌方，实际海上装备作为辐射声源）的仿真场景。其核心构建思路遵循：**水声环境数据库构建 -> 装备数据库构建 -> 仿真核心函数库支撑 -> 动态仿真运行与交互**的模式。

## 1.1 仿真系统构建与运行逻辑概述

一个典型的水下声学仿真系统可以看作由几个关键模块交互构成：

1.  **水声环境数据库 (Static Data)**: 这是仿真的"地理"和"物理"背景。它存储了相对静态或可预设的环境参数，如海底地形、声速剖面、以及统计性的环境噪声特性。**该模块为仿真运行提供基础的环境输入。**

2.  **装备数据库 (Static & Dynamic Attributes)**: 这是仿真中所有"演员"（红方单元、蓝方目标）的"属性表"。它定义了各平台的物理特性、传感器参数、行为逻辑、以及核心的声学特征（如蓝方的辐射噪声特征、声源级SL；红方传感器的探测阈值等）。**该模块为仿真运行提供所有平台的特性参数和行为规则。**

3.  **仿真核心函数库 (Algorithmic Engine)**: 如 `signal_lib.h` 所代表的算法集合。它包含了模拟各种物理过程（声波产生、传播、接收）和信号处理/分析（检测、特征提取）的数学模型和计算方法。**该模块是执行动态仿真的"计算引擎"，负责处理来自数据库的数据并模拟交互。**

4.  **动态仿真运行与交互流程 (Dynamic Process)**: 这是仿真的"主线剧情"。在此阶段，仿真引擎依据时间步进，驱动各平台根据装备数据库定义的行为运动，调用函数库中的算法模拟蓝方声源信号的产生与传播，红方传感器的接收与处理，最终评估红方的侦察效能。**此阶段是前三个模块数据和功能的动态综合与展现。**

后续章节将详细阐述这些模块的构建和它们在动态仿真流程中的作用。

## 2. 仿真系统构建模块

### 2.1 水声环境数据库构建与配置

*   **目标**: 建立一个全面的、可供仿真调用的水声环境参数集合，为仿真提供准确的物理背景。
*   **主要内容**:
    *   **地理与边界条件**:
        *   仿真海域的地理坐标范围。
        *   高精度水深地形数据（例如，数字高程模型 DEM 或数字海图）。
        *   海底底质类型及其声学特性（如声阻抗、反射系数、吸收系数、散射强度随频率和掠射角的变化）。
    *   **水文参数**:
        *   温度（T）、盐度（S）、静压力（或深度 D）的垂直剖面数据。这些是计算声速剖面（SVP）的基础，对声传播影响巨大。
        *   时变性：数据库应能支持或链接到能够提供不同季节、月份甚至特定日期/时间的T/S/D剖面数据，以反映海洋环境的动态变化（如混合层深度变化、跃层强度变化、中尺度涡等）。
    *   **声速剖面 (SVP)**:
        *   **生成与存储**: 基于上述T,S,D数据，通过标准声速经验公式（如Chen-Millero, Wilson, Del Grosso等）计算得到SVP。数据库应能存储多组SVP，对应不同区域、不同时间。
        *   **`signal_lib.h` 关联**: `SoundProfile` 结构用于在仿真运行时加载和传递选定的SVP。
            ```c
            typedef struct {
                double* depth;     // 深度数组(m)
                double* speed;     // 声速数组(m/s)
                size_t length;     // 数据点数
            } SoundProfile;
            ```

        **声速剖面 (SVP) 生成与加载**:
        *   **描述**: 声速在水中的垂直分布是影响声线轨迹和声场分布的关键因素。SVP可以通过以下方式获取：

            **1. 直接测量方法**:
            *   **声速剖面仪(SVP)**: 
            *   工作原理：通过发射声脉冲并测量传播时间来计算声速
            *   设备示例：AML SVPs等专业声速仪
            *   优点：实时性强、精度高（误差通常<0.1 m/s）
            *   缺点：需要专业设备，成本较高
            *   适用场景：高精度要求的科研、军事应用

            **2. 间接计算方法**:
            *   **基于CTD数据计算**:
                *   设备：温盐深仪(CTD)同步测量温度、盐度、压力
                *   常用经验公式：
                    *   Mackenzie公式(1981)：
                        ```
                        c = 1448.96 + 4.591T - 0.05304T² + 0.0002374T³ + 1.340(S-35) + 0.0163P
                        ```
                        其中：
                        - c: 声速(m/s)
                        - T: 温度(°C)
                        - S: 盐度(‰)
                        - P: 压力(dbar)
                    *   Chen-Millero公式(1977)：适用于更广的参数范围
                *   优点：成本低，仅需CTD数据
                *   缺点：依赖公式适用范围和输入参数精度

            **3. 混合应用策略**:
            *   **数据融合方法**:
                *   使用CTD数据计算声速作为基础值
                *   用声速仪测量值进行校准和验证
                *   建立误差修正模型
            *   **质量控制流程**:
                *   数据一致性检查
                *   异常值检测与处理
                *   时空插值优化
            *   **实际应用建议**:
                *   科研应用：优先使用直接测量值
                *   工程应用：可接受计算值，但需定期校准
                *   仿真应用：根据精度需求选择合适方法

        *   **相关算法/接口**:
            *   `SoundProfile` 结构用于存储SVP
            *   **实现接口 (`signal_lib.h`)**: 该库提供了一套完整的声速剖面生成、管理和应用接口：
                ```c
                // 创建和销毁声速剖面对象的基础函数
                SoundProfile* create_sound_profile(size_t length);
                void destroy_sound_profile(SoundProfile* profile);
                
                // 声速计算核心公式 - 分别实现Mackenzie和Chen-Millero公式
                double calculate_sound_speed_mackenzie(double temperature, double salinity, double depth);
                double calculate_sound_speed_chen_millero(double temperature, double salinity, double depth);
                
                // 从CTD数据生成声速剖面
                SoundProfile* generate_svp_from_ctd(const double* temperatures, const double* salinities, 
                                                  const double* depths, size_t length, int method);
                
                // 从声速仪直接测量数据创建声速剖面                              
                SoundProfile* create_svp_from_measurements(const double* depths, const double* speeds, size_t length);
                
                // 声速数据融合与质量控制功能
                SoundProfile* fuse_sound_profiles(const SoundProfile* measured_profile, 
                                                const SoundProfile* calculated_profile,
                                                double weight_measured);
                double interpolate_sound_speed(const SoundProfile* profile, double target_depth);
                int check_sound_profile_quality(const SoundProfile* profile);
                ```
            *   **计算流程示例**:
                1. 对于温盐深数据：先用`generate_svp_from_ctd`函数生成计算声速剖面
                2. 对于声速仪数据：用`create_svp_from_measurements`函数创建测量声速剖面
                3. 当两种数据都有时：可用`fuse_sound_profiles`函数融合两种数据
                4. 进行质量控制：用`check_sound_profile_quality`函数检查数据合理性
                5. 最终生成的声速剖面可直接输入到`ray_direction_calc`和`parabolic_equation_field`等传播计算函数中
                
            *   **知识点**: `算法知识目录.md` "1.1.1 声线射向计算模型" 和 "1.1.2 抛物方程声场计算" 都依赖于精确的声速剖面

    *   **环境级背景噪声场 (Ambient Noise Field)**:
        *   **组成与重要性**: 环境噪声是影响被动声学系统探测性能的决定性因素之一，它构成了信号检测的背景。主要来源包括：
            *   **远距离航运噪声**: 通常是10Hz - 1kHz频段内海洋噪声的主要贡献者，尤其在繁忙航道附近。
            *   **风生噪声 (Wind-dependent Noise)**: 由海面风浪引起，主要影响500Hz以上的较高频段，其强度与风速密切相关。
            *   **生物噪声 (Biological Noise)**: 海洋生物（如鲸、海豚、鱼群、底栖无脊椎动物如鼓虾）发出的声音，具有时空和频谱的显著特征性，在某些区域和季节可能成为主导噪声。
            *   **地球物理噪声 (Geophysical Noise)**: 如微地震、海底火山活动等产生的极低频噪声。
            *   **降水噪声 (Precipitation Noise)**: 雨、雪、冰雹等降落在海面会产生独特的、通常是宽带的噪声。
            *   **冰区噪声 (Ice Noise)**: 在极地或高纬度海域，海冰的形成、融化、破裂、漂移和相互作用会产生强烈且复杂的噪声。
            *   **水动力噪声 (Hydrodynamic Noise)**: 如强海流流经粗糙海底、内波破碎等产生的声音。
        *   **建模与数据**:
            *   **经验统计模型**: 如经典的Wenz曲线、Knudsen曲线，它们基于风速、航运密度等参数给出统计性的噪声谱级。`signal_lib.h`中的 `calculate_ambient_noise(double wind_speed, double shipping_density, double freq)` 是这类简化模型的接口。
            *   **`calculate_ambient_noise` 的考量与扩展**:
                *   **当前作用**: 提供了一种基于风速和航运密度的快速估算方法，适用于初步评估或缺乏详细数据的场景。
                *   **潜在的深化方向与系统性考虑**:
                    *   **深度依赖性**: 您提到"当前系统考虑了不同深度的温度和盐度产生的影响"，这对于环境噪声来说非常重要。`calculate_ambient_noise` 本身不直接接受深度参数来调整噪声级。一个完善的环境数据库或噪声模型应能反映噪声场随深度的变化，这通常与声速剖面、海底反射、以及表面噪声源向下传播的衰减特性有关。例如，可以通过更复杂的声场模型（如基于简正波或PE方法）计算远场分布的航运噪声或风噪声在不同深度的贡献。
                    *   **其他噪声源的综合**: 完整的噪声数据库应包含或链接到上述其他主要噪声源（生物、降水、冰区等）的统计模型或实测数据集，并能根据想定条件（地理位置、季节、时间）选择性地叠加这些噪声分量。
                    *   **频谱与方向性细节**: 数据库应提供详细的噪声功率谱密度（而不仅仅是单频点的值）和可能的垂直/水平方向性数据（例如，表面源噪声在水下通常具有垂直方向性）。这对于高精度阵列处理仿真至关重要。
                    *   **时空变异性**: 理想的数据库应能反映噪声的短期（如阵雨）和长期（如季节性生物活动、年度平均风速变化）的动态特性。
            *   **数据库应包含**:
                *   不同海区、季节、昼夜、海况（风速、浪高）下的统计噪声谱数据（谱级、可能的三维方向性）。
                *   特定噪声源（如主要航道分布、已知生物活跃区、历史地震数据）的地理信息。
                *   可能需要集成或接口到更专业的海洋噪声预报模型。
        *   **`signal_lib.h` 关联**: 虽然 `calculate_ambient_noise` 是一个直接的接口，但更全面的环境噪声数据（无论来自数据库还是复杂模型）最终会体现为计算NL（噪声级）的输入，供 `calculate_passive_sonar` 等性能评估函数使用。

### 2.2 装备数据库构建与配置

*   **目标**: 集中管理仿真中所有红方和蓝方平台的详细参数、声学特性和行为规则。
*   **红方装备参数 (侦察单元)**:
    *   **通用参数**: 平台ID、类型（坐底UUV、机动UUV、潜标类型）、尺寸、排水量等。
    *   **传感器套件**:
        *   水听器/阵列类型: 全向单水听器、水平线列、垂直线列、平面阵、共形阵等。
        *   阵元参数: 阵元数量 (`array_elements`)、间距 (`element_spacing`)、几何布局、单个阵元的灵敏度、指向性。
        *   工作参数: 工作频带、采样率、系统自噪声级、动态范围。
        *   信号处理能力: （若在平台端进行部分处理）可用的处理算法、处理增益。
        *   **`signal_lib.h` 关联**: `array_elements`, `element_spacing` 等直接用于 `calculate_array_gain`。
    *   **坐底侦察UUV**:
        *   部署参数：预设的固定地理位置（经纬度）、部署深度。
        *   工作模式：长期值守、周期性唤醒、数据存储/传输策略。
    *   **机动侦察UUV**:
        *   推进与机动性能：动力类型（电池、燃料电池等）、最大航速、巡航速度、最大深度、续航时间/航程。
        *   导航系统：定位精度（如GPS/INS/LBL/SBL）。
        *   平台噪声特性：自身航行时在不同速度和工况下辐射的噪声谱级和线谱特征（这对于评估其"隐蔽性"和"自噪声干扰"很重要）。
        *   行为逻辑：预设航线、巡逻模式、搜索算法、目标遭遇后的反应逻辑（如抵近、规避）。
    *   **潜标 (预投/实投)**:
        *   类型：被动（全向/指向性）、主动（信标）、环境测量型。
        *   部署参数：投放方式（空投、舰投）、入水后的工作深度、锚系方式、工作寿命。
        *   数据传输：无线（卫星、射频）、有线（若回收）。
*   **蓝方装备参数 (作为声源和被探测目标)**:
    *   **平台通用参数**: ID、类型（如特定型号的潜艇、驱逐舰、护卫舰、商船、无人艇、鱼雷等）、尺寸、排水量、材质等。
    *   **运动与行为**:
        *   机动性能：最大速度、加速度、转弯半径、下潜/上浮率。
        *   任务与行为逻辑：预设航线、巡逻区域、战术机动（如规避动作、搜索模式、攻击航路）。
    *   **声学特征 (核心数据)**:
        *   **辐射噪声 (Radiated Noise)**: 这是红方被动探测的主要依据。
            *   宽带谱：在不同工况（如航速档位、深度、主要设备运行模式如主辅机状态）下，辐射噪声的功率谱密度随频率的变化曲线。
            *   窄带线谱：关键的离散频率噪声成分，包括其中心频率、强度（SL）、带宽、稳定性、谐波族关系（如螺旋桨叶频及其谐波、柴油机缸频及其谐波、泵和电机的特征频率）。
            *   瞬态噪声：某些操作（如舱门开闭、鱼雷管注水、主动声纳开关机）可能产生的短时、特征性声信号。
        *   **主动声学系统 (若装备)**:
            *   声纳类型：搜索声纳、攻击声纳、导航声纳、探雷声纳、通信声纳等。
            *   工作参数：工作频率、带宽、脉冲形式（CW, LFM, HFM, PSK, FSK等）、脉冲宽度、重复频率、扫描方式、波束宽度、发射指向性。
            *   发射声源级 (SL_active)：其主动发射信号的声源级。
            *   **`signal_lib.h` 关联**: 可用 `generate_cw`, `generate_lfm` 等函数模拟其发射信号。
        *   **目标强度 (TS - Target Strength)**: 描述目标反射入射声波的能力，是红方主动声纳探测蓝方目标的关键参数。TS随目标的尺寸、形状、材质、姿态角（相对于入射声波的方向）和信号频率而变化。数据库应存储TS随这些因素变化的数据或模型。
        *   **自噪声 (Self-Noise)**: 蓝方平台自身的噪声，如果它也装备了声学传感器，这将是其传感器的背景噪声之一。
*   **数据来源**: 公开技术资料、学术研究、专业声学特性数据库、基于物理模型（如有限元/边界元方法计算TS或辐射噪声）的仿真结果、或根据经验公式和相似平台数据进行的估算。
*   **`signal_lib.h` 关联**: 蓝方平台的辐射噪声SL或主动发射信号的SL是 `calculate_passive_sonar` 和 `calculate_max_detection_range` 的核心输入。其辐射的信号特征（频谱、线谱）是红方进行 `spectrum_analysis`, `analyze_line_spectrum`, `extract_features` 的对象。

### 2.3 仿真核心函数库

*   **目标**: 提供一套经过验证的、标准化的算法模块，用于精确模拟水下声学环境中的物理现象、平台行为的声学表现以及传感器端的信号处理与分析过程。
*   **`signal_lib.h` 的角色与定位**:
    *   本文档中重点参考的 `signal_lib.h` 头文件及其对应的实现代码，构成了此仿真核心函数库的关键基础。它封装了大量水声信号处理和声场计算的基础算法。
    *   **提供的功能类别**:
        *   **基础数据结构**: `Signal` (时域信号), `Complex` (复数), `LineSpectrum` (线谱结果), `SoundProfile` (声速剖面), `SignalFeatures` (信号特征)。这些是数据在库函数间传递和存储的标准格式。
        *   **信号生成与合成**: `generate_basic_signal`, `generate_cw`, `generate_lfm`, `generate_hfm`, `generate_psk`, `generate_fsk`。主要用于模拟蓝方目标的主动声纳信号，或红方在测试、校准时使用的参考信号。
        *   **基础信号处理运算**: `fft`, `ifft` (快速傅里叶变换及其逆变换), `apply_hanning_window`, `apply_hamming_window` (窗函数应用), `complex_add`, `complex_subtract`, `complex_multiply`, `complex_divide`, `complex_abs`, `complex_phase` (复数运算)。这些是后续高级处理的基石。
        *   **声传播与声纳方程相关计算**:
            *   `ray_direction_calc`: 声线追踪模型，用于计算高频声传播路径。
            *   `parabolic_equation_field`: 抛物方程模型，用于计算较精确的声场分布。
            *   `calculate_transmission_loss`: 计算传播损失的通用接口。
            *   `calculate_ambient_noise`: 估算环境噪声级的接口。
            *   `calculate_array_gain`: 计算阵列增益。
            *   `calculate_passive_sonar`: 被动声纳方程计算，评估可探测性。
            *   `calculate_detection_probability`: 计算检测概率。
            *   `calculate_max_detection_range`: 计算最大探测距离。
        *   **信号检测与特征提取**:
            *   `matched_filter`: 匹配滤波，用于已知信号的检测。
            *   `spectrum_analysis`: 进行频谱分析。
            *   `analyze_line_spectrum`: 从频谱中提取线谱信息。
            *   `extract_features`: 提取信号的时域、频域特征。
*   **库的维护与扩展**:
    *   一个成熟的仿真系统会持续对函数库进行验证、优化和扩展。例如，可能需要增加更高级的声传播模型（如简正波模型、有限元/边界元接口）、复杂目标散射模型、多普勒效应精确计算模块、多基地协同探测算法、先进的自适应信号处理算法、以及机器学习驱动的特征增强或分类识别模块等。
*   **作用**: 该函数库是连接"静态"的**水声环境数据库**和**装备数据库**与"动态"的**仿真运行与交互流程**之间的核心纽带。它读取数据库中的参数，执行必要的物理过程模拟和数据分析计算，并将结果反馈给仿真引擎或用户。

## 3. 仿真运行与动态交互流程

此阶段是仿真系统的"执行"阶段，它依据时间步进，驱动想定中的各个实体活动，并模拟由此产生的声学交互和侦察对抗过程。

### 3.1 仿真初始化与想定加载

*   **描述**: 仿真引擎启动，根据用户选择或指定的想定文件，完成仿真运行前的所有准备工作。
*   **动作**:
    1.  **加载水声环境**:
        *   从 **水声环境数据库** 中读取并加载指定仿真海域的环境参数，包括但不限于：海底地形数据、选定的声速剖面 (`SoundProfile` 数据)、以及该区域和想定时间下的基础环境噪声场特性（如统计噪声谱、方向性数据）。
    2.  **加载装备与初始部署**:
        *   从 **装备数据库** 中读取并实例化所有红方侦察单元。根据想定配置其初始状态：
            *   **坐底侦察UUV**: 设置其固定的地理位置和工作深度。
            *   **机动侦察UUV**: 设置其初始出发点、航向、速度、深度，并加载其预定的巡逻航线或行为AI脚本。
            *   **预投潜标**: 记录其规划的投掷位置点，在仿真开始时可能处于"待激活"或"虚拟存在"状态，用于评估理论覆盖或引导后续"实投"。
            *   **实投潜标**: 若想定包含仿真开始即部署的实投潜标，则设置其初始位置和工作状态。
        *   同样从 **装备数据库** 中读取并实例化所有蓝方目标单元。根据想定配置其初始状态：平台类型、初始位置、航向、速度、深度、以及核心的声学特性（辐射噪声模型参数、主动声纳工作模式和参数、声源级SL、目标强度TS特性等）。
    3.  **初始化仿真时钟**: 设置仿真开始时间，确定仿真总时长和基本时间步长 (delta_t)。
    4.  **初始化数据记录器与显示界面**: 准备记录仿真过程中的关键数据，并配置用户监控界面。

### 3.2 动态仿真循环 (按时间步进)

仿真引擎按照预设的时间步长 (delta_t) 进入主循环，在每个时间步内顺序或并发执行以下核心任务：

#### 3.2.1 平台运动与状态更新

*   **描述**: 更新想定中所有活动单元（红方机动UUV、所有蓝方目标单元、以及可能由其他平台投送的实投潜标）的运动学和动力学状态。
*   **数据源/逻辑**:
    *   蓝方目标和红方机动UUV：根据其在 **装备数据库** 中定义的运动规划（预设航线、速度剖面）或行为AI逻辑（如规避、搜索、跟踪特定目标、区域巡逻）进行状态更新。
    *   实投潜标：若由载具（如飞机模型）投送，则模拟其入水、下沉到工作深度的过程。
*   **函数库调用**: 此部分主要依赖仿真引擎内置的运动学/动力学模型，而非 `signal_lib.h` 中的声学函数。
*   **产出**: 所有活动单元在当前时间步的精确位置（经纬度、深度）、速度矢量、姿态等。

#### 3.2.2 蓝方声源信号建模与发射

*   **描述**: 对于每一个蓝方目标单元，根据其当前更新的运动状态和在 **装备数据库** 中定义的声学特性，确定其在该时间步向外辐射的声信号。
*   **数据源**: **装备数据库** 中的蓝方目标声学特征（辐射噪声谱级和线谱随航速/工况的变化关系、主动声纳工作模式和参数、对应的SL）。
*   **函数库调用 (`signal_lib.h` 及扩展)**:
    *   **辐射噪声**:
        *   根据当前工况（如航速）从数据库查找对应的宽带噪声谱和线谱参数（频率、强度）。
        *   这些参数将作为后续声传播计算的声源项。
    *   **主动声纳发射**:
        *   如果蓝方目标的主动声纳在该时间步工作并发射脉冲，则调用如 `generate_cw()`, `generate_lfm()`, `generate_hfm()` 等函数，结合数据库中的波形参数和SL，生成该脉冲的数字时域信号 (`Signal` 对象)或其等效的频域描述。
*   **产出**: 当前时间步，每个蓝方目标声源向外辐射的声信号的完整描述（包括信号波形或频谱特性、声源级SL、发射方向性等）。

#### 3.2.3 声波传播计算

*   **描述**: 针对上一步产生的每一个蓝方声源信号，计算其从蓝方目标位置传播到红方每一个传感器（坐底UUV、机动UUV上的水听器、已激活的实投潜标）位置的过程。
*   **数据源**:
    *   蓝方声源的当前位置和信号特性（来自3.2.2）。
    *   红方各传感器的当前位置（来自3.2.1或初始化）。
    *   当前有效的声速剖面 (`SoundProfile`，来自 **水声环境数据库**）。
    *   海底地形和底质声学参数（来自 **水声环境数据库**）。
*   **函数库调用 (`signal_lib.h` 及扩展)**:
    *   根据信号频率、传播距离、环境复杂度，选择合适的声传播模型：
        *   `ray_direction_calc()`: 适用于高频、远距离或需要快速估计主要传播路径的场景。
        *   `parabolic_equation_field()`: 适用于需要更精确声场分布的场景，尤其在中低频。
        *   其他模型（如简正波、波数积分等，若库中包含）。
    *   从传播模型结果中提取或直接调用 `calculate_transmission_loss()` 计算每个声源到每个接收器的传播损失 (TL)。
*   **产出**: 对于每一个"蓝方声源-红方传感器"对，都得到该路径上的TL值，可能还包括信号的多径结构信息、到达时延、到达角（水平和垂直）等。

#### 3.2.4 信号在红方传感器处的叠加与接收

*   **描述**: 对每一个红方传感器，精确计算其在该时间步实际接收到的、混合了所有相关声学事件的总声信号。
*   **计算步骤**:
    1.  **目标信号贡献**: 对每一个能到达该红方传感器的蓝方声源：
        *   计算其信号到达强度：声源级 (SL) - 传播损失 (TL)。
        *   如果考虑多径，则每个有效路径贡献一个带有相应幅度和时延的信号分量。
        *   如果传感器是阵列，调用 `calculate_array_gain()` 考虑阵列对该方向来波的增益 (DI)。
    2.  **环境噪声叠加**:
        *   从 **水声环境数据库** 获取当前仿真环境下的背景噪声场特性（如噪声谱级和方向性）。
        *   `calculate_ambient_noise()` 可作为设定局部噪声级的一个参考。
        *   将环境噪声（根据其频谱和方向性）正确地与目标信号能量进行叠加。
    3.  **平台自噪声 (对机动UUV)**:
        *   从 **装备数据库** 获取机动UUV在当前航速下的自噪声特性，并将其叠加到接收信号中。
*   **函数库调用 (`signal_lib.h` 及扩展)**: `complex_add` (若信号以复数形式处理以保留相位用于阵列处理), `calculate_array_gain`。
*   **产出**: 每个红方传感器在该时间步接收到的原始混合时域 `Signal` 对象，该对象是多个蓝方目标信号（可能）、环境噪声、平台自噪声（若有）的综合体。

#### 3.2.5 红方信号处理与检测

*   **描述**: 红方各侦察单元（或其后方处理中心）对接收到的混合 `Signal` 对象进行一系列处理，以从中检测出是否存在蓝方目标信号。
*   **数据源**: 上一步产出的原始混合 `Signal` 对象。
*   **函数库调用 (`signal_lib.h` 及扩展)**:
    *   **预处理**:
        *   带通滤波：根据目标信号的预期频带滤除带外噪声。
        *   窗函数应用：`apply_hanning_window()`, `apply_hamming_window()`，为后续FFT做准备。
    *   **频域变换**: `fft()`。
    *   **核心检测算法**:
        *   **能量检测**: 在特定频带内计算信号能量，与预设阈值比较。
        *   **频谱分析与线谱检测**: 调用 `spectrum_analysis()` 得到频谱，再调用 `analyze_line_spectrum()` 寻找由蓝方目标产生的稳定线谱特征。
        *   **匹配滤波**: 若期望检测蓝方某种已知波形信号（如特定声纳ping），使用 `matched_filter()`。
        *   **自适应处理**: 更高级的算法可能包括自适应噪声抵消、自适应波束形成等（若函数库支持）。
*   **检测条件应用 (检测域)**:
    *   将处理结果与在 **装备数据库** 中为该红方传感器配置的"检测条件"或"检测域"参数进行比较。这些参数可能包括：
        *   最小信噪比 (SNR) 阈值。
        *   能量检测门限。
        *   线谱检测的最小峰高、数量、频率吻合度等。
        *   信号持续时间要求。
    *   `dt` (检测阈值) 在 `calculate_passive_sonar` 中是系统级综合门限的体现。
*   **产出**: 初步的检测报告，例如："红方单元X在时间T检测到来自方位Y、频率Z的疑似蓝方目标信号，信噪比为S"。

#### 3.2.6 红方特征提取与识别 (若已触发检测)

*   **描述**: 一旦某个红方传感器判定检测到潜在的蓝方目标信号，则启动更细致的特征提取流程，以辅助对目标的分类和识别。
*   **数据源**: 已确认被检测到的信号段（可能是原始信号的截取，或处理后的信号）。
*   **函数库调用 (`signal_lib.h` 及扩展)**:
    *   `extract_features()`: 提取信号的时域特征（均值、方差、峰度、峭度等）和频域特征（中心频率、谱峰频率、带宽等）。
    *   `analyze_line_spectrum()` 的结果（线谱频率、幅值、相对关系）本身就是极其重要的特征。
    *   其他高级特征提取算法（如LOFAR谱图特征、DEMON谱分析、时频分析特征等，若库支持）。
*   **产出**: `SignalFeatures` 对象，或更丰富的特征集，用于描述检测到的信号。
*   **后续比对与识别**:
    *   将提取到的特征向量与 **装备数据库** 中存储的蓝方各类型目标的"声纹特征库"进行比对。
    *   识别逻辑（如基于模板匹配、统计分类器、或机器学习模型）可能在仿真引擎的核心逻辑中，或调用外部专业识别模块。
*   **产出**: 对检测目标的初步分类/识别结果（如"疑似XX型潜艇"）。

#### 3.2.7 数据记录、可视化与状态更新

*   **描述**: 记录当前时间步的关键仿真数据，更新仿真内部状态，并可能向用户界面提供可视化信息。
*   **动作**:
    *   记录所有平台的详细状态。
    *   记录红方传感器的原始接收数据、处理后的数据、检测结果、提取的特征。
    *   记录蓝方声源的发射情况和传播损失。
    *   更新战场态势图（若有）。
    *   检查仿真是否达到结束条件。

### 3.3 仿真结束与结果分析

*   **描述**: 当仿真达到预设的结束时间，或满足特定的想定结束条件（如某方完成任务、某关键目标被摧毁等）时，动态仿真循环终止。
*   **动作**:
    1.  **数据汇总与后处理**: 对仿真过程中记录的海量数据进行整理、统计和分析。
    2.  **性能评估**:
        *   调用 **仿真核心函数库** 中的性能评估函数，如 `calculate_passive_sonar()`, `calculate_detection_probability()`, `calculate_max_detection_range()`，对红方侦察系统在整个仿真过程或特定关键遭遇事件中的表现进行量化评估。这些评估会综合考虑从数据库读取的平台参数、环境参数，以及动态仿真中实际发生的声传播和信号交互情况。
    3.  **生成仿真报告**: 输出包含关键性能指标、事件序列、统计图表、以及可能的态势回放数据的仿真报告。
    4.  **结果可视化**: 以图表、动画等形式展示仿真结果。

## 4. 仿真流程中各平台的作用

### 4.1 红方侦察单元

#### 4.1.1 坐底侦察UUV
*   **角色**: 在关键水道、港口入口、或预定防御阵地进行长期、定点、隐蔽的被动声学监视。主要任务是实现对特定区域的态势感知、早期预警、收集通过性目标的声学特征数据，或作为水下固定侦察网络的一个节点。
*   **数据与库的交互**:
    *   **初始化**: 从**装备数据库**获取自身传感器参数（阵列配置、灵敏度、工作频带、检测阈值设定）和固定的部署位置。从**水声环境数据库**获取其部署点周围的SVP和预期背景噪声参考。
    *   **动态运行**: 持续接收混合声信号（由蓝方信号经传播与环境噪声叠加而成）。使用**仿真核心函数库**中的算法（如`fft`, `spectrum_analysis`, `analyze_line_spectrum`, `extract_features`)对接收信号进行处理，并依据装备数据库中定义的检测条件（或动态调整的阈值）进行目标检测和特征提取。
    *   **性能评估**: 其对特定蓝方目标的理论探测性能可使用 `calculate_passive_sonar`, `calculate_max_detection_range` 等函数，结合环境和目标参数进行评估。

#### 4.1.2 机动侦察UUV
*   **角色**: 执行更具灵活性和主动性的侦察任务，例如：对指定海域进行大范围巡逻搜索；根据其他传感器（如坐底UUV、预投潜标）提供的初步情报，进行目标抵近观察和查证；对已发现的特定高价值目标进行短时跟踪（若其隐蔽性和机动性能允许）。
*   **数据与库的交互**:
    *   **初始化与规划**: 除了与坐底UUV类似的参数外，还需从**装备数据库**获取其机动性能参数、平台自噪声模型、以及初始任务规划（航线、搜索模式、行为AI）。
    *   **动态运行**: 在仿真引擎驱动下沿规划路径机动。其实际接收信号会叠加自身平台噪声。信号处理和检测逻辑与坐底UUV类似，但可能需要更强的自适应处理能力（如自适应噪声抵消，若函数库支持）和更智能的检测阈值管理，以应对变化的背景噪声和与目标间的相对动态。
    *   **行为交互**: 其探测结果可能触发自身的行为改变（如转向、调整深度、改变搜索策略），这部分由仿真引擎的AI模块控制。

#### 4.1.3 潜标 (预投与实投)
*   **预投潜标**:
    *   **角色**: 在仿真想定规划阶段，预投潜标代表了计划中的传感器部署点或期望形成的侦察场。它们主要用于：
        *   仿真前的覆盖分析和传感器布局优化。
        *   指导机动UUV的初始搜索区域或航路规划。
        *   在仿真中，若想定允许，它们可以被"激活"为实投潜标。
    *   **数据交互**: 主要在想定编辑和仿真初始化阶段从**装备数据库**读取其规划位置和预期性能参数。
*   **实投潜标**:
    *   **角色**: 在仿真过程中实际部署并开始工作的声学传感器节点，通常执行被动监听任务。可以由空中平台、水面舰艇或UUV布放，快速在关注海域形成临时的或消耗性的侦察覆盖。
    *   **数据与库的交互**:
        *   **部署**: 其初始位置和状态由投送平台的动态行为决定。一旦入水工作，其参数（来自**装备数据库**)和周围环境（来自**水声环境数据库**)生效。
        *   **信号处理**: 与坐底UUV类似，但通常其搭载的信号处理能力和功耗预算更为有限，可能仅执行基础的频谱分析、能量检测或关键线谱提取，并将原始数据或初步结果通过通信链路（若有模型支持）传回。
        *   **`signal_lib.h`应用**: 基础的 `fft`, `spectrum_analysis`, `analyze_line_spectrum`。

### 4.2 蓝方目标单元 (作为声源和被探测对象)
*   **角色**: 仿真中红方侦察系统的主要"对手"和"目标"。它们通过自身正常的活动（如航行、设备运转）或有意的行为（如使用主动声纳）产生声信号。这些声信号是红方进行探测、定位、跟踪、分类和识别的唯一线索。
*   **数据与库的交互**:
    *   **定义**: 其所有物理特性、运动模式、行为逻辑、以及核心的声学特征（辐射噪声谱、线谱数据库、主动声纳参数、目标强度TS模型、声源级SL随工况的变化）均在仿真开始前由**装备数据库**详细定义和配置。
    *   **信号产生**: 在动态仿真中，其辐射的声信号（若为主动发射）的波形可由**仿真核心函数库**的`generate_...`系列函数依据数据库参数实时生成。其被动辐射噪声特性则直接从数据库中根据当前工况调取。
    *   **作为声源**: 其产生的声信号（携带SL信息）经过**仿真核心函数库**中的声传播模型（如`ray_direction_calc`, `parabolic_equation_field`, `calculate_transmission_loss`)计算衰减后，成为红方各传感器接收信号的源项。

## 5. 总结与展望

本文档在之前版本的基础上，进一步结合了典型的水下仿真系统构建思路（水声环境数据库 -> 装备数据库 -> 仿真核心函数库 -> 动态运行与交互），对仿真流程进行了重组和深化。特别针对环境噪声的复杂性、红蓝双方在想定中的具体配置（包括坐底/机动UUV、预投/实投潜标等红方单元，以及作为声源的蓝方海上装备）、以及"检测域"的概念进行了补充。

核心目标是展现一个结构化、模块化的仿真设计思想，其中：
*   **数据库**提供静态和动态属性支持。
*   **函数库** (`signal_lib.h`作为代表)提供核心算法能力。
*   **动态运行流程**将数据和算法结合，模拟复杂的水下声学对抗场景。

**未来展望 (在之前基础上进一步聚焦)**:
*   **数据库的智能化与动态化**:
    *   **环境数据库**: 实现与实时海洋环境预报系统（如HYCOM, ROMS）的接口，动态更新SVP和背景噪声场。集成更细致的地理依赖性生物噪声和人为活动噪声模型。
    *   **装备数据库**: 引入更高级的目标行为模型（基于AI或脚本），使蓝方目标能对红方行为做出更逼真的反应（如规避、干扰、反探测）。红方UUV也可具备更强的自主决策能力。
*   **函数库的深度与广度扩展**:
    *   **声传播**: 增强对三维、复杂边界、时变信道的建模能力。
    *   **信号处理**: 重点发展多传感器数据融合算法（针对UUV集群和潜标网络）、微弱信号检测、以及基于深度学习的特征提取和目标识别技术。
    *   **平台特性**: 更精细的UUV自噪声模型，潜标漂移模型，通信链路模型等。
*   **仿真框架的协同与验证**:
    *   支持多平台协同侦察战术的仿真与评估。
    *   建立标准测试场景和指标，用于验证仿真结果的准确性和可信度。
    *   探索与实际海试数据的对比验证方法。

通过持续迭代和完善这三大核心模块（数据库、函数库、运行引擎），可以构建出功能更强大、配置更灵活、结果更逼真的水下仿真平台，为水声技术研究、装备效能评估和作战概念验证提供坚实支撑。 